{% extends "layout.html" %}

{% block css %}
    {{ super() }}
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.9.3/css/bootstrap-select.min.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.2.0/styles/default.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/hljs_github.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/editor/design.css') }}">
{% endblock %}

{% block js %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/vendor/editor/highlight.pack.js') }}"></script>
    <script src="{{ url_for('static', filename='js/vendor/editor/dropzone.js') }}"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.9.3/js/bootstrap-select.min.js"></script>

    <script src="{{ url_for('static', filename='ace/ace.js') }}"></script>
    <script src="{{ url_for('static', filename='js/vendor/editor/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/editor_utils.js') }}"></script>
{% endblock %}

{% block body %}

<div id="editor-section">
    <div class="row editor-preview-wrapper">

        {% include "editor_error.html" %}

        {% include "editor_help.html" %}

        <div class="col-xs-12 col-sm-6 editor-column" id="droppable-area">
            <div class="editor-header">
                <img src="/static/img/light-logo.png" alt="hack.guides()" class="editor-ps-logo img-responsive">

                <button onclick="save('{{article.sha}}', '{{article.path}}', '{{secondary_repo}}')" class="btn btn-primary btn-save">Save</button>
                <button onclick="cancel()" class="btn btn-danger btn-cancel">Cancel</button>

                <div class="editor-features">
                    <button id="btn-scroll-sync" data-toggle="tooltip" data-placement="bottom" title="Syncrhonize your place in guide between editor and preview panes" class="btn btn-default btn-xs hidden-xs hidden-sm">Scroll Sync</button>
                    <button id="btn-live-tutorial" class="btn btn-default btn-xs markdown-help">Live Markdown Tutorial <span class="fa fa-question-circle"></span></button>
                    <button id="btn-upload" data-toggle="tooltip" data-placement="bottom" title="Dragging and dropping images onto editor also supported" class="btn btn-default btn-xs btn-dropzone">Add image</button>
                    <button id="btn-show-help" data-toggle="tooltip" data-placement="bottom" title="Show help" class="btn btn-default btn-xs active">Help</button>
                </div>

                <br />

                <input id="title" name="title" type="text" placeholder="Title" data-toggle="tooltip" data-placement="bottom" title="Concise and descriptive, a good title is 130 characters or less" is 130 charmaxlength="130" value="{{article.title}}" {{'readOnly="true"' if article else ""}} {% if not article %}autofocus{% endif %} required="required"/>
                <input id="original_stack" name="original_stack" type="hidden" value="{{article.stacks[0] if article else ''}}" />
                <br /> <br />

                <select id="stacks" name="stacks" class="selectpicker" data-width="100%" data-size="6" data-dropup-auto="false" data-header="Scroll for additional stacks" data-title="Stacks" required="required">
                    <option value="" {{"selected" if not selected_stack}}>Stack</option>
                    {% for stack in stacks %}
                        <option value="{{ stack }}" {{"selected" if selected_stack and selected_stack == stack}}>{{ stack }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="editor-wrapper">
                <div id="editor"></div>
            </div>

            <div class="editor-footer">
                <div class="dz-preview dz-file-preview" id="preview-template" style="display: none;">
                    <div class="dz-details" style="display: none;">
                    <div class="dz-filename" style="display: none;"><span data-dz-name></span></div>
                    <div class="dz-size" data-dz-size style="display: none;"></div>
                        <img data-dz-thumbnail />
                    </div>
                    <div class="dz-progress" style="display: none;"><span class="dz-upload" data-dz-uploadprogress></span></div>
                    <div class="dz-success-mark" style="display: none;"><span>✔</span></div>
                    <div class="dz-error-mark" style="display: none;"><span>✘</span></div>
                    <div class="dz-error-message"><span data-dz-errormessage></span></div>
                </div>

            </div>
        </div>

        <div class="col-xs-12 col-sm-6 preview-column">
            <div class="preview-header">
                <div class="preview-text hidden-xs hidden-sm">PREVIEW</div>
                <div id="article-title" class=""></div>
                <div id="article-stack" class=""></div>
            </div>

            <div id="preview"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function cancel() {
        window.location.href = "{{url_for('index')}}";
    }

    $(document).ready(function() {
        init_editor_help();

        var local_filename = '{{ article.sha or "hack.guides-draft" }}';
        {% autoescape false %}
        var original_content = '{{ article.content | replace("\n", "\\n") | replace("\r", "") | replace("'", "\\'") | replace("/script", "\\/script") }}';
        {% endautoescape %}
        var author_name = '{{ '' if not article.author_name else article.author_name }}';
        var author_real_name = '{{ '' if not article.author_real_name else article.author_real_name }}';
        var img_upload_url = '{{ url_for("img_upload") }}';
        var editor = initialize_editor(local_filename, original_content, author_name, author_real_name, img_upload_url);

        $("#title").change(function() {
            $("#article-title").html($("#title").val() || 'Untitled');
        });
        $("#stacks").change(function() {
            var stacks = $('#stacks').val();
            $("#article-stack").html(stacks ? 'Related to <i>' + stacks + '</i>' : 'no stack defined yet');
        });
        $("#title").change();
        $("#stacks").change();

        openFullscreen();
        showHelp();

        $("#btn-scroll-sync").click(function() {
            toggleScrollSync();
            $("#btn-scroll-sync").toggleClass('active');
        });

        /* Enable scroll syncing by default */
        $("#btn-scroll-sync").click();

        $("#btn-live-tutorial").click(function() {
            toggleLiveTutorial();
            $("#btn-live-tutorial").toggleClass('active');
        });

        $('#btn-show-help').click(function() {
            toggleHelp();
            $("#btn-show-help").toggleClass('active');
        });

        $('#editor-help #close').click(function() {
            hideHelp();
            $("#btn-show-help").toggleClass('active');
        });

        /* Initialize bootstrap tooltips */
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>
{% endblock %}
