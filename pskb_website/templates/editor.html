{% extends "layout.html" %}

{% block css %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.9.3/css/bootstrap-select.min.css">
{% endblock %}

{% block js %}
    {{super()}}
    <script src="/static/js/vendor/editor/highlight.pack.js"></script>
    <script src="/static/js/vendor/editor/epiceditor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.9.3/js/bootstrap-select.min.js"></script>
{% endblock %}

{% block body %}

<div id="editor">
    <h3>1. Get Started</h3>
    <p>
        <ul>
            <li>Saving your tutorial will send it straight to our official <a href="https://github.com/pluralsight/tutorials/"> Github repository</a> where editors around the world can help you fullfill your article's potential.</li>
            <li>We'll put it on our <a href="/">homepage</a> so your expertise can help educate the world once our editors feel your article is ready.</li>
        </ul>
    </p>
    <h3>2. Pick a Title</h3>
    <input id="title" name="title" type="text" class="form-control article-title" placeholder="Title" value="{{article.title}}" {{'readOnly="true"' if branch_article else ""}} />

    <br />
    <h3>3. Write</h3>
    <p>
        <ul>
            <li>The editor supports <a href="http://daringfireball.net/projects/markdown/">markdown format</a>, which means you can create great looking tutorials with a bit of special syntax:
                <ul>
                    <li>Surround text with ** to make this **<b>bold</b>**.</li>
                    <li>Use - in front of lines to automatically create lists.</li>
                    <li>Use # to make header text and much more.</li>
                    <li>Get more tips <a
                        href="http://daringfireball.net/projects/markdown/syntax">here</a>.</li>
                </ul>
            <li>
                We'll automatically a create Table of Contents for your
                tutorial based on your usage of &lt;h1&gt; through &lt;h6&gt;
                tag.
            </li>
            <li>
                Start with &lt;h1&gt; for your main point and use larger header
                tags to nest your supporting points.
            </li>
            <li>
                Use the preview button when hovering over the editor to get a
                quick look at how your content will look once published.
            </li>
        </ul>
    </p>

    <div id="epiceditor"></div>
    <br />

    <h3>4. Choose your stack</h3>
    <p>
        Picking a stack to categorize your tutorial will help readers find it
        more easily.
    </p>
    <select id="stacks" name="stacks" class="form-control selectpicker stacks-editor" data-size="6"  data-dropup-auto="false" data-header="Scroll for additional stacks" data-title="Stacks">
        {% for stack in stacks %}
            <option value="{{ stack }}" {{"selected" if selected_stack and selected_stack == stack}}>{{ stack }}</option>
        {% endfor %}
    </select>

    <br />
    <br />

    <button onclick="save()" class="btn btn-primary">Save</button>

    <textarea id="content" style="display:none">{{article.content}}</textarea>
</div>

<script type="text/javascript">
    var editor = new EpicEditor({
        clientSideStorage: false,
        textarea: "content",
        basePath: '/static/css/vendor/editor/',
        autogrow: true,
        theme: {
            base: '/themes/base/epiceditor.css',
            preview: '/themes/preview/github.css',
            editor: '/themes/editor/epic-light.css'
        },
    }
    ).load();

    iframe = editor.getElement('previewerIframe');

    /* Have to dynamically stuff in the correct css in the iframe for the
     * editor */
    css = document.createElement('link');
    css.href = "/static/css/vendor/github.css";
    css.rel = "stylesheet";
    css.type = "text/css";
    iframe.contentDocument.head.appendChild(css);

    css = document.createElement('link');
    css.href = "/static/css/vendor/bootstrap.min.css";
    css.rel = "stylesheet";
    css.type = "text/css";
    iframe.contentDocument.head.appendChild(css);

    css = document.createElement('link');
    css.href = "/static/css/base.css";
    css.rel = "stylesheet";
    css.type = "text/css";
    iframe.contentDocument.head.appendChild(css);

    function add_article_header_data() {
        var preview_div = editor.getElement('previewerIframe').contentDocument.getElementById('epiceditor-preview');
        var title = document.getElementById('title').value;

        var header = document.createElement('div');
        header.className = 'header';

        var h1 = document.createElement('h1')
        h1.id = 'title';
        h1.className = 'tagline gradient-text';
        h1.textContent = title;
        header.appendChild(h1);

        var h4 = document.createElement('h4');
        h4.id = 'author';

        var small = document.createElement('small');
        small.textContent = 'written by ';

        var anchor = document.createElement('a');
        anchor.href= '/user/{{article.author_name}}';
        anchor.textContent = '{{article.author_real_name if article.author_real_name else article.author_name}}';

        small.appendChild(anchor);
        h4.appendChild(small);
        header.appendChild(h4);

        var selected_stacks = document.getElementById('stacks').selectedOptions;
        var stacks = '';
        for (ii = 0; ii < selected_stacks.length; ii++) {
            if (selected_stacks[ii].value != '') {
                stacks += selected_stacks[ii].value + ',';
            }
        }

        if (stacks.length) {
            if (stacks[stacks.length - 1] == ',') {
                stacks = stacks.slice(0, -1);
            }
            var h5 = document.createElement('h5');
            h5.id = 'related';
            var small = document.createElement('small');
            small.textContent = 'Related to ' + stacks;

            h5.appendChild(small);
            header.appendChild(h5);
        }

        header.appendChild(document.createElement('hr'));
        preview_div.insertBefore(header, preview_div.firstChild);
    }

    /* Inject header information as it would appear on a regular page since
     * this content is not directly in the editor box */
    editor.on('preview', add_article_header_data);
    editor.on('fullscreenenter', function() {
        /* Force top of document up so it aligns with top of the markdown text */
        var html = editor.getElement('previewerIframe').contentDocument.firstChild;
        html.setAttribute('style', html.getAttribute('style') + 'margin-top: -90px;');
    });


function save() {
    var form = document.createElement("form");
    form.action = "/save/";
    form.method = "POST";

    var content = document.createElement("input");
    content.name = "content";
    content.value = editor.exportFile("", "json");
    form.appendChild(content.cloneNode());

    var sha = document.createElement("input");
    sha.name = "sha";
    sha.value = "{{article.sha}}"
    form.appendChild(sha.cloneNode());

    var path = document.createElement("input");
    path.name = "path";
    path.value = "{{article.path}}"
    form.appendChild(path.cloneNode());

    var title = document.getElementById("title");
    form.appendChild(title.cloneNode());

    var stacks_select = document.getElementById("stacks");
    var stacks = document.createElement("input");
    stacks.name = "stacks";
    stacks.value = stacks_select.value;
    form.appendChild(stacks.cloneNode());

    {% if secondary_repo %}
        var secondary_repo = document.createElement("input");
        secondary_repo.name = "secondary_repo";
        secondary_repo.value = 1;
        form.appendChild(secondary_repo.cloneNode());
    {% endif %}

    // To be sent, the form needs to be attached to the main document.
    form.style.display = "none";
    document.body.appendChild(form);

    form.submit();

    // But once the form is sent, it's useless to keep it.
    document.body.removeChild(form);
};

</script>
{% endblock %}
